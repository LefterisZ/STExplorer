---
title: "Untitled"
author: "Eleftherios Zormpas"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loadPackages}
library(pryr)
library(lineprof)
library(lobstr)
```

```{r memory_checks}
gwr_list <- vector(mode = "list", length = length(sampleNames_selected))
gwr_runs <- vector(mode = "list", length = length(formulas))
names(gwr_list) <- sampleNames_selected
names(gwr_runs) <- names(formulas)

print(c(address(gwr_list), refs(gwr_list)))
print(c(address(gwr_runs), refs(gwr_runs)))

tracemem(gwr_runs)

```

```{r check}
for (id in sampleNames_selected[1:2]) {
  message("Working on sample: ", id, " (", i, "/", length(sampleNames_selected), ")")

  for (i in seq_along(formulas)[1:2]) {
    ## Some formulas return `Error: inv(): matrix is singular`. This is because
    ## there are too few values in the area to generate a regression model.
    ## For the sake of running everything once and tackling the erroring formulas
    ## one by one, we wrap everything inside a tryCatch function.
    tryCatch({
      message("Working on formula: ", names(formulas[i]), " (", i, "/", length(formulas), ")")

      ### ----Set Bandwidth ----------------------------------------------------#
      message("\tSetting bandwidth...")
      spot_diameter <- msfe@sfe_data[[id]]@metadata[["spotDiameter"]][[id]][["spot_diameter_fullres"]]
      bw <- 12*spot_diameter


      ### ----Run GWR -----------------------------------------------------------#
      message("\tRunning GWR...")
      gwr_runs[[names(formulas[i])]] <- gwrSTE(gwr_method = "basic",
                                               formula = formulas[[i]],
                                               m_sfe = msfe,
                                               sample_id = id,
                                               bw = bw,
                                               kernel = "exponential")
    }, error = function(e){cat("ERROR: ", conditionMessage(e), "\n")})
    
    print(c(address(gwr_runs), refs(gwr_runs)))
  }

  ## Update output list
  message("Updating the list of GWR runs per sample.")
  gwr_list[[id]] <- gwr_runs
  print(c(address(gwr_list), refs(gwr_list)))
}

```


```{r check_mem}
obj_size(gwr_runs)
format(object.size(gwr_runs), standard = "legacy")
obj_size(gwr_runs[["GLB1~IL6R"]]$lm$terms)
format(object.size(gwr_runs[["GLB1~IL6R"]]$lm$terms), standard = "legacy")
obj_size(gwr_runs[["GLB1~IL6R"]]$lm$model)
format(object.size(gwr_runs[["GLB1~IL6R"]]$lm$model), standard = "legacy")
obj_size(gwr_runs[["GLB1~IL6R"]])
format(object.size(gwr_runs[["GLB1~IL6R"]]), standard = "legacy")


```
